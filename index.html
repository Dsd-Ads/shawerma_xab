<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–∞—É—Ä–º–∞ –•–∞–± ‚Äî –ù–∞—Å–ª–æ–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #248b91);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 100px; }
        header { padding: 12px; text-align: center; font-weight: 600; border-bottom: 0.5px solid rgba(0,0,0,0.1); position: sticky; top: 0; background: var(--bg-color); z-index: 10; }
        
        .category-header { padding: 20px 16px 8px; font-size: 14px; font-weight: 600; color: var(--hint-color); text-transform: uppercase; }
        
        .item-card-wrapper { border-bottom: 0.5px solid rgba(0,0,0,0.05); padding: 16px; }
        .item-main { display: flex; justify-content: space-between; align-items: flex-start; }
        .item-title { font-size: 17px; font-weight: 600; }
        .price { font-weight: 700; color: var(--button-color); margin-top: 4px; }
        
        .add-main-btn { 
            background: var(--button-color); color: var(--button-text); border: none; 
            padding: 8px 16px; border-radius: 12px; font-weight: 600; cursor: pointer;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è "–Ω–∞—Å–ª–æ–µ–Ω–Ω—ã—Ö" –ø–æ–∑–∏—Ü–∏–π */
        .instances-container { margin-top: 10px; }
        .instance-item { 
            background: var(--secondary-bg); border-radius: 12px; padding: 12px; margin-bottom: 10px; 
            border: 1px solid rgba(0,0,0,0.05); animation: slideIn 0.2s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .instance-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--hint-color); }
        .remove-btn { color: #ff3b30; border: none; background: none; font-size: 12px; cursor: pointer; }

        .addon-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .addon-chip { 
            display: flex; align-items: center; background: var(--bg-color); padding: 6px; 
            border-radius: 8px; font-size: 12px; border: 1px solid rgba(0,0,0,0.1);
        }
        .addon-chip input { margin-right: 6px; }

        textarea, select { 
            width: 100%; margin-top: 8px; padding: 8px; border-radius: 8px; 
            border: 1px solid rgba(0,0,0,0.1); font-size: 13px; box-sizing: border-box; 
        }
    </style>
</head>
<body>

<header>–®–∞—É—Ä–º–∞ –•–∞–±</header>
<div id="menu-list"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const menuItems = [
        { id: "sh_kur", title: "–®–∞—É—Ä–º–∞ –∫—É—Ä–∏—Ü–∞", price: 290, category: "üåØ –®–∞—É—Ä–º–∞" },
        { id: "combo_1", title: "–ö–æ–º–±–æ ‚Ññ1", price: 490, category: "üç± –ö–æ–º–±–æ", 
          selects: [{ id: "drink", label: "–ù–∞–ø–∏—Ç–æ–∫", options: ["–ö–æ–ª–∞", "–ê–π—Ä–∞–Ω", "–í–æ–¥–∞"] }] 
        }
    ];

    const addonsList = [{ n: "üßÄ –°—ã—Ä", p: 40 }, { n: "üî• –•–∞–ª–∞–ø–µ–Ω—å–æ", p: 30 }];

    // –•—Ä–∞–Ω–∏–º –∫–æ—Ä–∑–∏–Ω—É –∫–∞–∫ id: [ {addons:[], comment:"", extra:0}, ... ]
    let cart = {};

    function render() {
        const list = document.getElementById('menu-list');
        list.innerHTML = '';

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        let lastCat = "";
        menuItems.forEach(item => {
            if (item.category !== lastCat) {
                list.innerHTML += `<div class="category-header">${item.category}</div>`;
                lastCat = item.category;
            }

            const itemInstances = cart[item.id] || [];
            const instancesHTML = itemInstances.map((inst, idx) => `
                <div class="instance-item">
                    <div class="instance-header">
                        <span>–í–ê–†–ò–ê–ù–¢ #${idx + 1}</span>
                        <button class="remove-btn" onclick="removeInstance('${item.id}', ${idx})">–£–î–ê–õ–ò–¢–¨</button>
                    </div>
                    ${item.selects ? item.selects.map(s => `
                        <select onchange="updateSelect('${item.id}', ${idx}, '${s.id}', this.value)">
                            ${s.options.map(opt => `<option value="${opt}" ${inst.selects && inst.selects[s.id] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    `).join('') : ''}
                    <div class="addon-grid">
                        ${addonsList.map(a => `
                            <label class="addon-chip">
                                <input type="checkbox" ${inst.addons.includes(a.n) ? 'checked' : ''} 
                                    onchange="toggleAddon('${item.id}', ${idx}, '${a.n}', ${a.p})">
                                ${a.n} (+${a.p}‚ÇΩ)
                            </label>
                        `).join('')}
                    </div>
                    <textarea placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." oninput="updateComment('${item.id}', ${idx}, this.value)">${inst.comment || ''}</textarea>
                </div>
            `).join('');

            list.innerHTML += `
                <div class="item-card-wrapper">
                    <div class="item-main">
                        <div>
                            <div class="item-title">${item.title}</div>
                            <div class="price">${item.price} ‚ÇΩ</div>
                        </div>
                        <button class="add-main-btn" onclick="addInstance('${item.id}')">+ –î–û–ë–ê–í–ò–¢–¨</button>
                    </div>
                    <div class="instances-container">${instancesHTML}</div>
                </div>`;
        });
        updateMainBtn();
    }

    function addInstance(id) {
        if (!cart[id]) cart[id] = [];
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        const item = menuItems.find(i => i.id === id);
        const initialSelects = {};
        if (item.selects) item.selects.forEach(s => initialSelects[s.id] = s.options[0]);

        cart[id].push({ addons: [], comment: "", extra: 0, selects: initialSelects });
        tg.HapticFeedback.impactOccurred('medium');
        render();
    }

    function removeInstance(id, idx) {
        cart[id].splice(idx, 1);
        if (cart[id].length === 0) delete cart[id];
        render();
    }

    function toggleAddon(id, idx, name, price) {
        const inst = cart[id][idx];
        const aIdx = inst.addons.indexOf(name);
        if (aIdx > -1) {
            inst.addons.splice(aIdx, 1);
            inst.extra -= price;
        } else {
            inst.addons.push(name);
            inst.extra += price;
        }
        updateMainBtn();
    }

    function updateComment(id, idx, val) { cart[id][idx].comment = val; }
    function updateSelect(id, idx, sId, val) { cart[id][idx].selects[sId] = val; }

    function updateMainBtn() {
        let total = 0;
        let count = 0;
        for (const id in cart) {
            const item = menuItems.find(i => i.id === id);
            cart[id].forEach(inst => {
                total += (item.price + inst.extra);
                count++;
            });
        }
        if (count > 0) {
            tg.MainButton.setParams({ text: `–û–§–û–†–ú–ò–¢–¨ ${count} –ü–û–ó. (${total} ‚ÇΩ)`, is_visible: true });
        } else { tg.MainButton.hide(); }
    }

    tg.onEvent('mainButtonClicked', () => {
        const order = [];
        for (const id in cart) {
            const item = menuItems.find(i => i.id === id);
            cart[id].forEach((inst, idx) => {
                order.push({
                    –ù–∞–∑–≤–∞–Ω–∏–µ: item.title,
                    –í–∞—Ä–∏–∞–Ω—Ç: idx + 1,
                    –í—ã–±–æ—Ä: inst.selects ? JSON.stringify(inst.selects) : "–Ω–µ—Ç",
                    –î–æ–±–∞–≤–∫–∏: inst.addons.join(', ') || "–Ω–µ—Ç",
                    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: inst.comment || "–Ω–µ—Ç",
                    –ò—Ç–æ–≥–æ_–∑–∞_–µ–¥: item.price + inst.extra
                });
            });
        }
        tg.sendData(JSON.stringify(order));
    });

    render();
</script>
</body>
</html>
