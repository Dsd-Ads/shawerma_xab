<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–∞—É—Ä–º–∞ –•–∞–± ‚Äî –ú–µ–Ω—é</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --link-color: var(--tg-theme-link-color, #248bed);
            --button-color: var(--tg-theme-button-color, #248b91);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0;
            user-select: none; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth;
        }

        header {
            background-color: var(--bg-color); position: sticky; top: 0; z-index: 100;
            padding: 12px; text-align: center; font-weight: 600; border-bottom: 0.5px solid rgba(0,0,0,0.1);
        }

        .category-header {
            padding: 20px 16px 8px; font-size: 14px; font-weight: 600;
            color: var(--hint-color); text-transform: uppercase; letter-spacing: 0.5px;
        }

        .item-card-wrapper { border-bottom: 0.5px solid rgba(0,0,0,0.05); padding: 12px 16px; }
        .item-main { display: flex; gap: 12px; align-items: center; justify-content: space-between; }
        .item-info { flex-grow: 1; }
        .item-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .price { font-weight: 700; color: var(--button-color); }

        .add-main-btn {
            background-color: var(--button-color); color: var(--button-text); border: none;
            padding: 8px 16px; border-radius: 10px; font-weight: 600; cursor: pointer;
        }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ù–ê–°–õ–û–ï–ù–ò–Ø */
        .instances-list { margin-top: 10px; }
        .instance-item {
            background-color: var(--secondary-bg); border-radius: 12px; padding: 12px;
            margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .instance-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .instance-label { font-size: 11px; font-weight: 800; color: var(--hint-color); text-transform: uppercase; }
        .remove-btn { color: #ff3b30; background: none; border: none; font-size: 12px; font-weight: 600; cursor: pointer; }

        .addon-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
        .addon-item {
            display: flex; align-items: center; font-size: 12px;
            background: var(--bg-color); padding: 6px; border-radius: 8px; border: 0.5px solid rgba(0,0,0,0.05);
        }
        .addon-item input { margin-right: 6px; accent-color: var(--button-color); }

        textarea {
            width: 100%; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);
            padding: 8px; font-size: 13px; background: var(--bg-color);
            color: var(--text-color); box-sizing: border-box; resize: none; font-family: inherit;
        }

        .bottom-space { height: 100px; }
    </style>
</head>
<body>

<header>–®–∞—É—Ä–º–∞ –•–∞–±</header>
<div id="menu-list"></div>
<div class="bottom-space"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const menuItems = [
        { id: "sh_kur_st", category: "üåØ –®–∞—É—Ä–º–∞", title: "–®–∞—É—Ä–º–∞ –∫—É—Ä–∏—Ü–∞ (–°—Ç–∞–Ω–¥–∞—Ä—Ç)", price: 290 },
        { id: "sh_svin_st", category: "üåØ –®–∞—É—Ä–º–∞", title: "–®–∞—É—Ä–º–∞ —Å–≤–∏–Ω–∏–Ω–∞ (–°—Ç–∞–Ω–¥–∞—Ä—Ç)", price: 320 },
        { id: "hd_cl", category: "üå≠ –•–æ—Ç-–¥–æ–≥–∏", title: "–•–æ—Ç-–¥–æ–≥ –∫–ª–∞—Å—Å–∏–∫", price: 320 },
        { id: "z_fri", category: "üçü –ó–∞–∫—É—Å–∫–∏", title: "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏", price: 130 }
    ];

    const addonsList = [
        { n: "üßÄ –°—ã—Ä", p: 40 },
        { n: "üî• –•–∞–ª–∞–ø–µ–Ω—å–æ", p: 30 },
        { n: "üçü –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", p: 30 }
    ];

    // –ö–æ—Ä–∑–∏–Ω–∞ —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç –º–∞—Å—Å–∏–≤—ã: cart['id'] = [ {addons: [], comment: ""}, ... ]
    let cart = {};

    function render() {
        const list = document.getElementById('menu-list');
        list.innerHTML = '';
        
        let currentCat = "";
        menuItems.forEach(item => {
            if (item.category !== currentCat) {
                list.innerHTML += `<div class="category-header">${item.category}</div>`;
                currentCat = item.category;
            }

            const instances = cart[item.id] || [];
            const instancesHTML = instances.map((inst, idx) => `
                <div class="instance-item">
                    <div class="instance-header">
                        <div class="instance-label">–ü–æ–∑–∏—Ü–∏—è #${idx + 1}</div>
                        <button class="remove-btn" onclick="removeInstance('${item.id}', ${idx})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    <div class="addon-grid">
                        ${addonsList.map(a => `
                            <label class="addon-item">
                                <input type="checkbox" ${inst.addons.some(added => added.n === a.n) ? 'checked' : ''} 
                                    onchange="toggleAddon('${item.id}', ${idx}, '${a.n}', ${a.p})">
                                ${a.n} (+${a.p}‚ÇΩ)
                            </label>
                        `).join('')}
                    </div>
                    <textarea placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–±–µ–∑ –ª—É–∫–∞ –∏ —Ç.–¥.)" rows="1" 
                        oninput="updateComment('${item.id}', ${idx}, this.value)">${inst.comment}</textarea>
                </div>
            `).join('');

            list.innerHTML += `
                <div class="item-card-wrapper">
                    <div class="item-main">
                        <div class="item-info">
                            <div class="item-title">${item.title}</div>
                            <div class="price">${item.price} ‚ÇΩ</div>
                        </div>
                        <button class="add-main-btn" onclick="addInstance('${item.id}')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    <div class="instances-list">${instancesHTML}</div>
                </div>`;
        });
        updateMainBtn();
    }

    function addInstance(id) {
        if (!cart[id]) cart[id] = [];
        cart[id].push({ addons: [], comment: "" });
        tg.HapticFeedback.impactOccurred('medium');
        render();
    }

    function removeInstance(id, idx) {
        cart[id].splice(idx, 1);
        if (cart[id].length === 0) delete cart[id];
        tg.HapticFeedback.notificationOccurred('success');
        render();
    }

    function toggleAddon(id, idx, name, price) {
        const inst = cart[id][idx];
        const existingIdx = inst.addons.findIndex(a => a.n === name);
        if (existingIdx > -1) {
            inst.addons.splice(existingIdx, 1);
        } else {
            inst.addons.push({ n: name, p: price });
        }
        updateMainBtn();
    }

    function updateComment(id, idx, text) {
        cart[id][idx].comment = text;
    }

    function updateMainBtn() {
        let total = 0;
        let count = 0;

        for (const id in cart) {
            const item = menuItems.find(i => i.id === id);
            cart[id].forEach(inst => {
                let instTotal = item.price;
                inst.addons.forEach(a => instTotal += a.p);
                total += instTotal;
                count++;
            });
        }

        if (count > 0) {
            tg.MainButton.setParams({
                text: `–û–§–û–†–ú–ò–¢–¨ ${count} –ü–û–ó. ‚Äî ${total} ‚ÇΩ`,
                is_visible: true,
                color: '#248b91'
            });
        } else {
            tg.MainButton.hide();
        }
    }

    tg.onEvent('mainButtonClicked', function() {
        const finalOrder = [];
        let finalTotal = 0;

        for (const id in cart) {
            const item = menuItems.find(i => i.id === id);
            cart[id].forEach((inst, idx) => {
                let price = item.price;
                inst.addons.forEach(a => price += a.p);
                
                finalTotal += price;
                finalOrder.push({
                    –ù–∞–∑–≤–∞–Ω–∏–µ: item.title,
                    –ù–æ–º–µ—Ä: idx + 1,
                    –î–æ–±–∞–≤–∫–∏: inst.addons.map(a => a.n).join(', ') || '–Ω–µ—Ç',
                    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: inst.comment || '–Ω–µ—Ç',
                    –¶–µ–Ω–∞: price
                });
            });
        }

        tg.sendData(JSON.stringify({ 
            –∑–∞–∫–∞–∑: finalOrder, 
            –∏—Ç–æ–≥–æ: finalTotal,
            –¥–µ—Ç–∞–ª–∏: "–ü–µ—Ä–µ–¥–∞–Ω–æ —Å –Ω–∞—Å–ª–æ–µ–Ω–∏–µ–º (–∫–∞–∂–¥–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)" 
        }));
        
        tg.MainButton.showProgress();
        setTimeout(() => tg.close(), 500);
    });

    render();
</script>
</body>
</html>
